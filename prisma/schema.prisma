// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(Student)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations with distinct names
  save              Save?
  asTeacher         TeacherStudent[]    @relation("TeacherStudents_teacher")
  asStudent         TeacherStudent[]    @relation("TeacherStudents_student")
  asParent          ParentChild[]       @relation("ParentChild_parent")
  asChild           ParentChild[]       @relation("ParentChild_child")
  certificates      Certificate[]       @relation("UserCertificates")
  createdModules    Module[]            @relation("TeacherModules")
  moduleAssignments ModuleAssignment[]  @relation("StudentAssignments")

  @@map("users")
}

model TeacherStudent {
  id        Int      @id @default(autoincrement())
  teacherId Int
  studentId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teacher User @relation("TeacherStudents_teacher", fields: [teacherId], references: [id], onDelete: Cascade)
  student User @relation("TeacherStudents_student", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([teacherId, studentId])
  @@map("teacher_students")
}

model ParentChild {
  id        Int      @id @default(autoincrement())
  parentId  Int
  childId   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent User @relation("ParentChild_parent", fields: [parentId], references: [id], onDelete: Cascade)
  child  User @relation("ParentChild_child", fields: [childId], references: [id], onDelete: Cascade)

  @@unique([parentId, childId])
  @@map("parent_child")
}

model Save {
  userId Int  @id
  data   Json @default("{\"account\":null,\"progression\":{\"totalStarsEarned\":0,\"levelsFinished\":[],\"current_level_id\":\"\"},\"inventory\":[],\"shop\":{\"stars\":0,\"purchaseHistory\":[]}}")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("saves")
}

// NEW: AuthPin model for Google OAuth PIN verification
model AuthPin {
  pin       String   @id @db.VarChar(6)
  token     String   @db.Text
  username  String   @db.VarChar(255)
  firstName String?  @map("first_name") @db.VarChar(255)
  lastName  String?  @map("last_name") @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([expiresAt], map: "idx_auth_pins_expires_at")
  @@map("auth_pins")
}

// ✨ NEW: Certificate Model
model Certificate {
  id                String   @id @default(cuid())
  certificateNumber String   @unique @map("certificate_number")
  studentId         Int      @map("student_id")
  gradeLevel        String   @map("grade_level")
  achievement       String
  issuedBy          String   @map("issued_by")
  pdfUrl            String?  @map("pdf_url")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  student User @relation("UserCertificates", fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([certificateNumber])
  @@map("certificates")
}

// ✨ NEW: Module Model
model Module {
  id          Int        @id @default(autoincrement())
  name        String
  grade       Int
  subject     String
  teacherId   Int        @map("teacher_id")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  teacher     User                @relation("TeacherModules", fields: [teacherId], references: [id], onDelete: Cascade)
  questions   ModuleQuestion[]
  assignments ModuleAssignment[]

  @@index([teacherId])
  @@index([grade])
  @@map("modules")
}

// ✨ NEW: Module Question Model
model ModuleQuestion {
  id                 Int      @id @default(autoincrement())
  moduleId           Int      @map("module_id")
  questionText       String   @map("question_text") @db.Text
  answers            Json     // Array of 4 answers
  correctAnswerIndex Int      @map("correct_answer_index")
  correctAnswer      String   @map("correct_answer")
  createdAt          DateTime @default(now()) @map("created_at")

  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@map("module_questions")
}

// ✨ NEW: Module Assignment Model
model ModuleAssignment {
  id        Int      @id @default(autoincrement())
  moduleId  Int      @map("module_id")
  studentId Int      @map("student_id")
  completed Boolean  @default(false)
  score     Int?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  module  Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  student User   @relation("StudentAssignments", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([moduleId, studentId])
  @@index([studentId])
  @@index([moduleId])
  @@map("module_assignments")
}

enum Role {
  Student
  Teacher
  Parent
  Admin
}